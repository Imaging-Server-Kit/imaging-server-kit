events {}

http {
    client_max_body_size 500M;

    upstream servers_registry {
        server servers_registry:5000;
    }

    upstream rembg {
        server rembg:8000;
    }

    upstream stardist {
        server stardist:8000;
    }

    upstream mousetumornet {
        server mousetumornet:8000;
    }

    upstream spam {
        server spam:8000;
    }

    upstream tau-fibrils-yolo {
        server tau-fibrils-yolo:8000;
    }

    upstream orientationpy {
        server orientationpy:8000;
    }

    upstream skimage {
        server skimage:8000;
    }

    upstream trackpy {
        server trackpy:8000;
    }

    upstream ilastik {
        server ilastik:8000;
    }

    server {
        listen 80;

        location /services {
            proxy_pass http://servers_registry/services;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # This doesnt work.. wrong http prefix or sth
        # location / {
        #     proxy_pass http://$1;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        # }

        location /rembg/ {
            rewrite ^/rembg(/.*)$ $1 break;
            proxy_pass http://rembg;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /stardist/ {
            rewrite ^/stardist(/.*)$ $1 break;
            proxy_pass http://stardist;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /mousetumornet/ {
            rewrite ^/mousetumornet(/.*)$ $1 break;
            proxy_pass http://mousetumornet;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
        }

        location /spam/ {
            rewrite ^/spam(/.*)$ $1 break;
            proxy_pass http://spam;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /tau-fibrils-yolo/ {
            rewrite ^/tau-fibrils-yolo(/.*)$ $1 break;
            proxy_pass http://tau-fibrils-yolo;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /orientationpy/ {
            rewrite ^/orientationpy(/.*)$ $1 break;
            proxy_pass http://orientationpy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /skimage/ {
            rewrite ^/skimage(/.*)$ $1 break;
            proxy_pass http://skimage;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /trackpy/ {
            rewrite ^/trackpy(/.*)$ $1 break;
            proxy_pass http://trackpy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /ilastik/ {
            rewrite ^/ilastik(/.*)$ $1 break;
            proxy_pass http://ilastik;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
